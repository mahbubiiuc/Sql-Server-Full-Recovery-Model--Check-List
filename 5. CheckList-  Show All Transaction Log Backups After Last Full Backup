-- Step 1: Get the last full backup timestamp
WITH LastFullBackup AS (
    SELECT MAX(backup_finish_date) AS LastFullBackupFinishDate
    FROM msdb.dbo.backupset
    WHERE database_name = 'MINTDB'
      AND type = 'D' -- D = Full Backup
)

-- Step 2: Get all log backups after that
SELECT  
    b.database_name,
	b.type,
    b.backup_start_date,
    b.backup_finish_date,
	mf.physical_device_name,
	(SUM(CASE WHEN b.type = 'L' THEN b.backup_size / 1024 / 1024 ELSE 0 END) OVER (ORDER BY b.database_name)) / 1024 AS TOTAL_Trans_BackupSize_GB,
    b.first_lsn,
    b.last_lsn,
    b.checkpoint_lsn,
    b.backup_size / 1024 / 1024 AS BackupSizeMB,
	CASE WHEN b.type = 'D' THEN 'RESTORE DATABASE ['+b.database_name+'] FROM DISK = '''+mf.physical_device_name+''' WITH REPLACE, NORECOVERY, STATS = 5;'
		 ELSE 'RESTORE LOG ['+b.database_name+'] FROM DISK = '''+mf.physical_device_name+''' WITH NORECOVERY;'
	END RestoreCommand
FROM msdb.dbo.backupset b
JOIN msdb.dbo.backupmediafamily mf ON b.media_set_id = mf.media_set_id
CROSS JOIN LastFullBackup lfb
WHERE b.database_name = 'MINTDB'
  AND b.type IN ('D', 'L') -- L = Log Backup
  AND b.backup_finish_date >= lfb.LastFullBackupFinishDate
  --AND cast(b.backup_finish_date as date) = cast('2025-09-29' as date)
ORDER BY b.backup_start_date desc;
